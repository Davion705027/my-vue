{"version":3,"file":"reactivity.esm-bundler.js","sources":["../../shared/src/general.ts","../src/effect.ts","../src/baseHandlers.ts","../src/reactive.ts"],"sourcesContent":["/*\n * @FilePath: /my-vue/packages/shared/src/general.ts\n * @Description:\n */\nexport const isObject = (v: any) => typeof v === \"object\" && v !== null;\nexport const extend = Object.assign;\nexport const isFunction = (v: any) => typeof v === \"function\";\nexport const isString = (v: any) => typeof v === \"string\";\nexport const isArray = Array.isArray;\n\nexport const objectToString = Object.prototype.toString;\nexport const toTypeString = (value: any) => objectToString.call(value);\nexport const toRawType = (value: any) => toTypeString(value).slice(8, -1);\n\nexport const isPlainObject = (value: any) =>\n  toTypeString(value) === \"[object Object]\";\nexport const isPromise = (val: any) => {\n  return isObject(val) && isFunction(val.then) && isFunction(val.catch);\n};\nexport const isDate = (val: any) => toTypeString(val) === \"[object Date]\";\nexport const isRegExp = (val: any) => toTypeString(val) === \"[object RegExp]\";\n\nexport const def = (\n  obj: any,\n  key: string,\n  value: any,\n  enumerable: boolean = false\n) => {\n  Object.defineProperty(obj, key, {\n    value,\n    enumerable,\n    writable: true,\n    configurable: true,\n  });\n};\n","/*\n * @FilePath: /my-vue/packages/reactivity/src/effect.ts\n * @Description:\n */\nimport { Target } from \".\";\nimport { TrackOpTypes } from \"./operations\";\n\nconst targetMap = new WeakMap();\n\nlet activeEffect: ReactiveEffect;\nexport function track(target: Target, type: TrackOpTypes, key: unknown) {\n  //   console.log(activeEffect);\n  let depsMap = targetMap.get(target);\n  if (!depsMap) {\n    targetMap.set(target, (depsMap = new Map()));\n  }\n  let dep = depsMap.get(key);\n  if (!dep) {\n    depsMap.set(key, (dep = new Set()));\n  }\n  dep.add(activeEffect);\n  //   console.log(targetMap);\n}\nexport function trigger(target: Target, key: unknown, value: any) {\n  const depsMap = targetMap.get(target);\n  if (!depsMap) {\n    return;\n  }\n  const effects: Set<ReactiveEffect> = new Set(depsMap.get(key));\n  effects.forEach((effect) => {\n    effect.run();\n    // if (effect.scheduler) {\n    //   effect.scheduler();\n    // } else {\n    //   effect.run();\n    // }\n  });\n}\n\ninterface ReactiveEffectOptions {\n  lazy?: boolean;\n  scheduler?: Function;\n}\nexport function effect(fn: Function, option: ReactiveEffectOptions) {\n  const _effect = new ReactiveEffect(fn);\n  if (!option || !option.lazy) {\n    _effect.run();\n  }\n\n  const runner = _effect.run.bind(_effect) as ReactiveEffectRunner;\n  runner.effect = _effect;\n  return runner;\n}\n\nexport interface ReactiveEffectRunner<T = any> {\n  (): T;\n  effect: ReactiveEffect;\n}\n\nexport class ReactiveEffect<T = any> {\n  active = true;\n  constructor(public fn: Function) {}\n  run() {\n    activeEffect = this;\n    return this.fn();\n  }\n}\n","/*\n * @FilePath: /my-vue/packages/reactivity/src/baseHandlers.ts\n * @Description:\n */\n\nimport { isObject } from \"@vue/shared\";\nimport { track, trigger } from \"./effect\";\nimport { TrackOpTypes } from \"./operations\";\nimport { Target, reactive, readonly } from \"./reactive\";\n\nclass MutableReactiveHandler {\n  constructor(\n    protected readonly _isReadonly = false,\n    protected readonly _shallow = false\n  ) {}\n  get(target: Target, key: string | symbol, receiver: object) {\n    const isReadonly = this._isReadonly,\n      shallow = this._shallow;\n    const res = Reflect.get(target, key, receiver);\n    if (!isReadonly) {\n      track(target, TrackOpTypes.GET, key);\n    }\n\n    if (shallow) {\n      return res;\n    }\n\n    if (isObject(res)) {\n      return isReadonly ? readonly(res) : reactive(res);\n    }\n\n    return res;\n  }\n\n  set(target: Target, key: string | symbol, value: any, receiver: object) {\n    const res = Reflect.set(target, key, value, receiver);\n\n    trigger(target, key, value);\n    return res;\n  }\n}\n\nexport const mutableHandles: ProxyHandler<object> =\n  new MutableReactiveHandler();\n","import { isObject } from \"@vue/shared\";\nimport { mutableHandles } from \"./baseHandlers\";\n\n/*\n * @FilePath: /my-vue/packages/reactivity/src/reactive.ts\n * @Description:\n */\nexport const enum ReactiveFlags {\n  SKIP = \"__v_skip\",\n  IS_REACTIVE = \"__v_isReactive\",\n  IS_READONLY = \"__v_isReadonly\",\n  IS_SHALLOW = \"__v_isShallow\",\n  RAW = \"__v_raw\",\n}\nexport interface Target {\n  [ReactiveFlags.SKIP]?: boolean;\n  [ReactiveFlags.IS_REACTIVE]?: boolean;\n  [ReactiveFlags.IS_READONLY]?: boolean;\n  [ReactiveFlags.IS_SHALLOW]?: boolean;\n  [ReactiveFlags.RAW]?: any;\n}\nexport const reactiveMap = new WeakMap<Target, any>();\nexport const shallowReactiveMap = new WeakMap<Target, any>();\nexport const readonlyMap = new WeakMap<Target, any>();\nexport const shallowReadonlyMap = new WeakMap<Target, any>();\n\nexport const isReadonly = (value: any) =>\n  !!(value && (value as Target)[ReactiveFlags.IS_READONLY]);\nexport const isReactive = (value: any) =>\n  !!(value && (value as Target)[ReactiveFlags.IS_REACTIVE]);\n\nexport const reactive = (target: object) => {\n  if (isReadonly(target)) {\n    return target;\n  }\n  return createReactiveObject(target, false, mutableHandles, reactiveMap);\n};\n\nexport const readonly = (target: object) => {};\n\nfunction createReactiveObject(\n  target: Target,\n  isReadonly: boolean,\n  baseHandles: ProxyHandler<any>,\n  proxyMap: WeakMap<Target, any>\n) {\n  if (!isObject(target)) {\n    return target;\n  }\n\n  const existingProxy = proxyMap.get(target);\n  if (existingProxy) {\n    return existingProxy;\n  }\n\n  const proxy = new Proxy(target, baseHandles);\n\n  proxyMap.set(target, proxy);\n  return proxy;\n}\n"],"names":[],"mappings":"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"}