{"version":3,"file":"reactivity.global.js","sources":["../../shared/src/general.ts","../src/effect.ts","../src/baseHandlers.ts","../src/reactive.ts"],"sourcesContent":["/*\n * @FilePath: /my-vue/packages/shared/src/general.ts\n * @Description:\n */\nexport const isObject = (v: any) => typeof v === \"object\" && v !== null;\nexport const extend = Object.assign;\nexport const isFunction = (v: any) => typeof v === \"function\";\nexport const isString = (v: any) => typeof v === \"string\";\nexport const isArray = Array.isArray;\n\nexport const objectToString = Object.prototype.toString;\nexport const toTypeString = (value: any) => objectToString.call(value);\nexport const toRawType = (value: any) => toTypeString(value).slice(8, -1);\n\nexport const isPlainObject = (value: any) =>\n  toTypeString(value) === \"[object Object]\";\nexport const isPromise = (val: any) => {\n  return isObject(val) && isFunction(val.then) && isFunction(val.catch);\n};\nexport const isDate = (val: any) => toTypeString(val) === \"[object Date]\";\nexport const isRegExp = (val: any) => toTypeString(val) === \"[object RegExp]\";\n\nexport const def = (\n  obj: any,\n  key: string,\n  value: any,\n  enumerable: boolean = false\n) => {\n  Object.defineProperty(obj, key, {\n    value,\n    enumerable,\n    writable: true,\n    configurable: true,\n  });\n};\n","/*\n * @FilePath: /my-vue/packages/reactivity/src/effect.ts\n * @Description:\n */\nimport { Target } from \".\";\nimport { TrackOpTypes } from \"./operations\";\n\nconst targetMap = new WeakMap();\n\nlet activeEffect: ReactiveEffect;\nexport function track(target: Target, type: TrackOpTypes, key: unknown) {\n  //   console.log(activeEffect);\n  let depsMap = targetMap.get(target);\n  if (!depsMap) {\n    targetMap.set(target, (depsMap = new Map()));\n  }\n  let dep = depsMap.get(key);\n  if (!dep) {\n    depsMap.set(key, (dep = new Set()));\n  }\n  dep.add(activeEffect);\n  //   console.log(targetMap);\n}\nexport function trigger(target: Target, key: unknown, value: any) {\n  const depsMap = targetMap.get(target);\n  if (!depsMap) {\n    return;\n  }\n  const effects: Set<ReactiveEffect> = new Set(depsMap.get(key));\n  effects.forEach((effect) => {\n    effect.run();\n    // if (effect.scheduler) {\n    //   effect.scheduler();\n    // } else {\n    //   effect.run();\n    // }\n  });\n}\n\ninterface ReactiveEffectOptions {\n  lazy?: boolean;\n  scheduler?: Function;\n}\nexport function effect(fn: Function, option: ReactiveEffectOptions) {\n  const _effect = new ReactiveEffect(fn);\n  if (!option || !option.lazy) {\n    _effect.run();\n  }\n\n  const runner = _effect.run.bind(_effect) as ReactiveEffectRunner;\n  runner.effect = _effect;\n  return runner;\n}\n\nexport interface ReactiveEffectRunner<T = any> {\n  (): T;\n  effect: ReactiveEffect;\n}\n\nexport class ReactiveEffect<T = any> {\n  active = true;\n  constructor(public fn: Function) {}\n  run() {\n    activeEffect = this;\n    return this.fn();\n  }\n}\n","/*\n * @FilePath: /my-vue/packages/reactivity/src/baseHandlers.ts\n * @Description:\n */\n\nimport { isObject } from \"@vue/shared\";\nimport { track, trigger } from \"./effect\";\nimport { TrackOpTypes } from \"./operations\";\nimport { Target, reactive, readonly } from \"./reactive\";\n\nclass MutableReactiveHandler {\n  constructor(\n    protected readonly _isReadonly = false,\n    protected readonly _shallow = false\n  ) {}\n  get(target: Target, key: string | symbol, receiver: object) {\n    const isReadonly = this._isReadonly,\n      shallow = this._shallow;\n    const res = Reflect.get(target, key, receiver);\n    if (!isReadonly) {\n      track(target, TrackOpTypes.GET, key);\n    }\n\n    if (shallow) {\n      return res;\n    }\n\n    if (isObject(res)) {\n      return isReadonly ? readonly(res) : reactive(res);\n    }\n\n    return res;\n  }\n\n  set(target: Target, key: string | symbol, value: any, receiver: object) {\n    const res = Reflect.set(target, key, value, receiver);\n\n    trigger(target, key, value);\n    return res;\n  }\n}\n\nexport const mutableHandles: ProxyHandler<object> =\n  new MutableReactiveHandler();\n","import { isObject } from \"@vue/shared\";\nimport { mutableHandles } from \"./baseHandlers\";\n\n/*\n * @FilePath: /my-vue/packages/reactivity/src/reactive.ts\n * @Description:\n */\nexport const enum ReactiveFlags {\n  SKIP = \"__v_skip\",\n  IS_REACTIVE = \"__v_isReactive\",\n  IS_READONLY = \"__v_isReadonly\",\n  IS_SHALLOW = \"__v_isShallow\",\n  RAW = \"__v_raw\",\n}\nexport interface Target {\n  [ReactiveFlags.SKIP]?: boolean;\n  [ReactiveFlags.IS_REACTIVE]?: boolean;\n  [ReactiveFlags.IS_READONLY]?: boolean;\n  [ReactiveFlags.IS_SHALLOW]?: boolean;\n  [ReactiveFlags.RAW]?: any;\n}\nexport const reactiveMap = new WeakMap<Target, any>();\nexport const shallowReactiveMap = new WeakMap<Target, any>();\nexport const readonlyMap = new WeakMap<Target, any>();\nexport const shallowReadonlyMap = new WeakMap<Target, any>();\n\nexport const isReadonly = (value: any) =>\n  !!(value && (value as Target)[ReactiveFlags.IS_READONLY]);\nexport const isReactive = (value: any) =>\n  !!(value && (value as Target)[ReactiveFlags.IS_REACTIVE]);\n\nexport const reactive = (target: object) => {\n  if (isReadonly(target)) {\n    return target;\n  }\n  return createReactiveObject(target, false, mutableHandles, reactiveMap);\n};\n\nexport const readonly = (target: object) => {};\n\nfunction createReactiveObject(\n  target: Target,\n  isReadonly: boolean,\n  baseHandles: ProxyHandler<any>,\n  proxyMap: WeakMap<Target, any>\n) {\n  if (!isObject(target)) {\n    return target;\n  }\n\n  const existingProxy = proxyMap.get(target);\n  if (existingProxy) {\n    return existingProxy;\n  }\n\n  const proxy = new Proxy(target, baseHandles);\n\n  proxyMap.set(target, proxy);\n  return proxy;\n}\n"],"names":[],"mappings":"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"}